(function(){
  if (typeof window !== 'undefined' && typeof window.VideoParser !== 'undefined') { return; }
  function concatParts(parts){ var total = 0; for (var i = 0; i < parts.length; i++) total += parts[i].length; var out = new Uint8Array(total); var off = 0; for (var j = 0; j < parts.length; j++) { out.set(parts[j], off); off += parts[j].length; } return out; }
  function concatBuf(a, b){ if (!(a instanceof Uint8Array)) a = new Uint8Array(a || 0); if (!(b instanceof Uint8Array)) b = new Uint8Array(b || 0); var out = new Uint8Array(a.length + b.length); out.set(a, 0); out.set(b, a.length); return out; }
  function hasAnnexB(buf){ for (var i = 0; i < buf.length - 4; i++){ if (buf[i] === 0 && buf[i+1] === 0){ if (buf[i+2] === 1) return true; if (buf[i+2] === 0 && buf[i+3] === 1) return true; } } return false; }
  function addStartCode(nal){ var out = new Uint8Array(nal.length + 4); out[0]=0; out[1]=0; out[2]=0; out[3]=1; out.set(nal,4); return out; }
  function HybridVideoParser(cb){ this.cb = cb; this.sps = null; this.pps = null; this.inited = false; this.buf = new Uint8Array(0); this.idrReady = false; }
  HybridVideoParser.prototype._emitInitIfReady = function(){ if (!this.inited && this.sps && this.pps){ this.inited = true; this.cb({ type: 'init', data: { sps: addStartCode(this.sps), pps: addStartCode(this.pps) } }); } };
  HybridVideoParser.prototype._inspectNal = function(nal){ if (!nal || !nal.length) return { type: 0, isIdr: false }; var type = nal[0] & 0x1f; var isIdr = type === 5; if (type === 7) this.sps = nal; else if (type === 8) this.pps = nal; return { type: type, isIdr: isIdr }; };
  HybridVideoParser.prototype._scanAnnexBNals = function(b){ var hasIdr = false; for (var i = 0; i < b.length - 4; i++){ if (b[i] === 0 && b[i+1] === 0 && ((b[i+2] === 1) || (b[i+2] === 0 && b[i+3] === 1))){ var start = (b[i+2] === 1) ? i+3 : i+4; var next = i+1; for (; next < b.length - 4; next++){ if (b[next] === 0 && b[next+1] === 0 && ((b[next+2] === 1) || (b[next+2] === 0 && b[next+3] === 1))) break; } var nal = b.slice(start, next); var info = this._inspectNal(nal); hasIdr = hasIdr || info.isIdr; i = next - 1; } } return hasIdr; };
  HybridVideoParser.prototype.appendFrame = function(chunk){ if (!(chunk instanceof Uint8Array)) chunk = new Uint8Array(chunk); var parts = []; var curHasIdr = false; if (hasAnnexB(chunk)){ var b = chunk; curHasIdr = this._scanAnnexBNals(b); this._emitInitIfReady(); if (!this.idrReady && curHasIdr && this.inited){ this.cb({ type: 'init', data: { sps: addStartCode(this.sps), pps: addStartCode(this.pps) } }); this.idrReady = true; } if (this.inited && (this.idrReady || curHasIdr)) { this.cb({ type: 'frame', data: chunk }); } return; }
    var offset = 0; var b = chunk; while (b.length - offset >= 4){ var len = (b[offset] << 24) | (b[offset+1] << 16) | (b[offset+2] << 8) | (b[offset+3]); if (len <= 0 || len > 5*1024*1024){ var len_le = (b[offset+3] << 24) | (b[offset+2] << 16) | (b[offset+1] << 8) | (b[offset]); if (len_le > 0 && len_le <= 5*1024*1024){ len = len_le; } else { break; } } if (b.length - offset - 4 < len) break; var start = offset + 4; var nal = b.slice(start, start + len); var info = this._inspectNal(nal); curHasIdr = curHasIdr || info.isIdr; parts.push(addStartCode(nal)); offset = start + len; }
    this._emitInitIfReady(); if (!this.idrReady && curHasIdr && this.inited){ this.cb({ type: 'init', data: { sps: addStartCode(this.sps), pps: addStartCode(this.pps) } }); this.idrReady = true; }
    if (parts.length && this.inited && (this.idrReady || curHasIdr)){ var joined = concatParts(parts); this.cb({ type: 'frame', data: joined }); }
  };
  HybridVideoParser.prototype.appendData = function(chunk){ if (!(chunk instanceof Uint8Array)) chunk = new Uint8Array(chunk); var b = concatBuf(this.buf, chunk); if (hasAnnexB(b)){ var indices = []; for (var i = 0; i < b.length - 4; i++){ if (b[i] === 0 && b[i+1] === 0 && ((b[i+2] === 1) || (b[i+2] === 0 && b[i+3] === 1))) indices.push(i); } if (indices.length >= 2){ var end = indices[indices.length - 1]; var frame = b.slice(0, end); this.appendFrame(frame); this.buf = b.slice(end); return; } else { this.buf = b; return; } }
    var offset = 0; var parts = []; var curHasIdr = false; while (b.length - offset >= 4){ var len = (b[offset] << 24) | (b[offset+1] << 16) | (b[offset+2] << 8) | (b[offset+3]); if (len <= 0 || len > 5*1024*1024){ var len_le = (b[offset+3] << 24) | (b[offset+2] << 16) | (b[offset+1] << 8) | (b[offset]); if (len_le > 0 && len_le <= 5*1024*1024){ len = len_le; } else break; } if (b.length - offset - 4 < len) break; var start = offset + 4; var nal = b.slice(start, start + len); var info = this._inspectNal(nal); curHasIdr = curHasIdr || info.isIdr; parts.push(addStartCode(nal)); offset = start + len; }
    this._emitInitIfReady(); if (!this.idrReady && curHasIdr && this.inited){ this.cb({ type: 'init', data: { sps: addStartCode(this.sps), pps: addStartCode(this.pps) } }); this.idrReady = true; }
    if (parts.length && this.inited && (this.idrReady || curHasIdr)){ var joined = concatParts(parts); this.cb({ type: 'frame', data: joined }); }
    this.buf = b.slice(offset);
  };
  if (typeof window !== 'undefined') window.VideoParser = HybridVideoParser; else if (typeof global !== 'undefined') global.VideoParser = HybridVideoParser;
})();
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cognitive Agent Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117; --panel:#1a1b26; --text:#e5e5e5; --accent:#4e9af1; --border:#2a2a38;
  --chat-width:360px; --safe-gutter:24px;
  --safe-right:calc(var(--chat-width) + var(--safe-gutter));
  --msg-user:#4e9af1; --msg-agent:#2b2b3a; --input-bg:#2a2a38;
}

/* å…¨å±€ */
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Helvetica,Arial;}

/* é¡¶æ  */
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 22px;background:var(--panel);border-bottom:1px solid var(--border);
}
header h1{margin:0;font-size:18px;color:var(--accent);font-weight:600;}

/* èˆå°æ•´ä½“å¸ƒå±€ */
.stage{
  padding:24px;
  padding-right:calc(var(--safe-right));
  padding-bottom:var(--safe-gutter);
}

/* ä¸»åŒºå¸ƒå±€ï¼šä¸Šä¸¤åˆ—ï¼ˆæ‰‹æœºã€è½¨è¿¹ï¼‰+ ä¸‹æ•´è¡Œï¼ˆæ—¥å¿—ï¼‰ */
.main-console{
  display:grid;
  grid-template-columns:280px 1fr;
  grid-template-rows:auto 240px;
  gap:24px;
  align-items:start;
  grid-template-areas:
    "phone traj"
    "logs logs";
}

/* å·¦ä¾§æ‰‹æœºåŒºåŸŸ */
.phone-container{
  grid-area:phone;
  display:flex;justify-content:center;align-items:center;
}
.phone-frame{
  background:linear-gradient(145deg,#1a1a1a,#2a2a2a);
  border-radius:36px;padding:6px;
  box-shadow:0 4px 18px rgba(0,0,0,0.35);
  display:flex;justify-content:center;align-items:center;
  position:relative;
}
.phone-screen{width:250px;height:520px;border-radius:24px;object-fit:contain;background:#000;}
/* æ‰‹æœºä¸­å¿ƒè¦†ç›–å±‚ï¼šè¿æ¥æŒ‰é’® */
.phone-overlay{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  display:flex;flex-direction:column;align-items:center;gap:8px;
  background:none;backdrop-filter:none;
  padding:0;border-radius:0;
}
.phone-overlay .btn{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
/* æ‰‹æœºæµ®åŠ¨é¢æ¿ */
.floating-panel{
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  width:760px;height:620px;overflow:auto;
  background:rgba(24,24,28,0.6);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:14px;
  backdrop-filter:saturate(180%) blur(18px);
  box-shadow:0 20px 50px rgba(0,0,0,0.55), inset 0 1px rgba(255,255,255,0.08);
  padding:16px;display:none;z-index:1000;
}
.floating-panel h4{margin:0 0 12px 0;color:var(--accent);font-size:16px;font-weight:600;text-align:center;letter-spacing:0.2px}
.floating-panel .row{display:flex;flex-wrap:wrap;gap:10px}
.floating-panel .btn{
  padding:8px 12px;border-radius:10px;cursor:pointer;color:#e5e5e5;
  background:linear-gradient(180deg, rgba(60,60,68,0.9), rgba(48,48,54,0.9));
  border:1px solid rgba(255,255,255,0.16);
  box-shadow:inset 0 -1px rgba(0,0,0,0.35), 0 1px 2px rgba(0,0,0,0.35);
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
}
.floating-panel .btn:hover{transform:translateY(-0.5px);background:linear-gradient(180deg, rgba(68,68,76,0.95), rgba(56,56,62,0.95));border-color:rgba(255,255,255,0.22)}
.floating-panel .btn:active{transform:translateY(0.5px);box-shadow:inset 0 1px rgba(0,0,0,0.35)}
.floating-panel .btn:focus{outline:none;box-shadow:0 0 0 3px rgba(62,130,246,0.35)}
.floating-panel .btn.primary{
  background:linear-gradient(180deg, #4e9af1, #3b82f6);
  border-color:#3b82f6;color:#fff;
  box-shadow:inset 0 -1px rgba(0,0,0,0.25), 0 4px 10px rgba(59,130,246,0.35);
}
.floating-panel .btn.primary:hover{background:linear-gradient(180deg, #5aa2f3, #4a8cf7)}
.floating-panel .btn.primary:active{background:linear-gradient(180deg, #3f8ef2, #3579e6)}
/* é€€å‡ºç”¨çº¢è‰²é•¿æ¡æŒ‰é’®æ ·å¼ */
.floating-panel .btn.danger{
  background:linear-gradient(180deg, #ff5a5f, #e0454a);
  border-color:rgba(255,86,94,0.6);
  color:#fff;
  box-shadow:inset 0 -1px rgba(0,0,0,0.25), 0 4px 10px rgba(224,69,74,0.35);
}
.floating-panel .btn.danger:hover{background:linear-gradient(180deg, #ff6b70, #e65358)}
.floating-panel .btn.danger:active{background:linear-gradient(180deg, #f24c52, #d63d42)}
.floating-panel .btn.block{display:block;width:100%;text-align:center;padding:10px 14px;border-radius:12px}

/* æ§åˆ¶ä¸­å¿ƒä¸»é¢˜ */
.control-center{display:flex;flex-direction:column;gap:12px}
.cc-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.12)}
.cc-title{font-weight:600;color:#eaeaea;letter-spacing:0.2px}
.cc-sub{color:#a9abb3;font-size:12px}
.cc-grid{display:grid;grid-template-columns:1fr;gap:12px}
.control-card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:12px;box-shadow:0 10px 20px rgba(0,0,0,0.25)}
.cc-card-title{color:#a9abb3;font-size:13px;margin-bottom:8px}
.cc-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.cc-actions.input-row{gap:10px}
.cc-actions.input-row input{flex:1;min-width:240px;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--input-bg);color:var(--text)}
.floating-panel .btn.pill{border-radius:999px;padding:8px 14px}

/* è®¾å¤‡è¯¦æƒ…å—æ ·å¼ */
#deviceList .details{margin:6px 0 8px 24px;padding:10px;border:1px solid rgba(255,255,255,0.14);border-radius:10px;background:rgba(255,255,255,0.04)}
/* Mac é£æ ¼çš„ KV åˆ—è¡¨ */
#deviceList .details .kv-list{display:grid;grid-template-columns:120px 1fr;gap:6px 12px;font-size:13px}
#deviceList .details .kv-item-label{color:#a9abb3;}
#deviceList .details .kv-item-value{color:#e5e5e5;word-break:break-all;opacity:0.95}
/* æ§åˆ¶é¢æ¿é¡¶å±‚è®¾å¤‡ä¿¡æ¯ KV æ ·å¼ */
#deviceInfoKV .overview-card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.14);border-radius:12px;padding:14px}
#deviceInfoKV .ov-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
#deviceInfoKV .ov-title{font-weight:600;color:#e5e5e5}
#deviceInfoKV .ov-actions{display:flex;gap:8px}
#deviceInfoKV .ov-actions .btn{padding:6px 8px;border-radius:8px}
#deviceInfoKV .ov-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px 24px}
#deviceInfoKV .ov-item{display:flex;flex-direction:column;gap:6px;padding:6px 8px;border-radius:8px}
#deviceInfoKV .ov-label{color:#a9abb3;font-size:13px;display:flex;align-items:center;gap:8px}
#deviceInfoKV .ov-value{color:#e5e5e5;font-size:15px}
#deviceInfoKV .kv-list{display:grid;grid-template-columns:120px 1fr;gap:6px 12px;font-size:13px}
#deviceInfoKV .kv-item-label{color:#a9abb3;}
#deviceInfoKV .kv-item-value{color:#e5e5e5;word-break:break-all;opacity:0.95}
 
 /* Trajectory é¢æ¿ */
.traj-panel{
  grid-area:traj;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  margin-right: 16px;
  padding:12px 16px;
  display:flex;
  flex-direction:column;
  height:540px;
}
.traj-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.traj-header b{color:var(--accent);}
.traj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;}
.traj-item{
  width:100%;
  height:80%;
  border:2px dashed var(--border);
  border-radius:12px;
  background:rgba(255,255,255,0.03);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#999;
  font-size:15px;
  font-weight:500;
  cursor:pointer;
  transition:all .25s ease;
}
.traj-item:hover{border-color:var(--accent);color:var(--accent);background:rgba(78,154,241,0.08);}
.traj-desc{
  text-align:center;
  margin-top:8px;
  font-size:13px;
  font-style:italic;
  color:#777;
  opacity:0.85;
}

/* Execution Logs é¢æ¿ï¼šä½äºæ‰‹æœºå’Œè½¨è¿¹ä¸‹æ–¹æ¨ªè·¨å…¨å®½ */
.logs-container{
  grid-area:logs;
  margin-right: 16px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  display:flex;
  flex-direction:column;
  height:280px;
  overflow-y:auto;
}
.logs-container h3{
  color:var(--accent);
  font-size:16px;
  margin:0;
  padding:12px 24px;
  position:sticky;
  top:0;
  background:var(--panel);
  z-index:1;
  border-bottom:1px solid var(--border);
}
#logArea{flex:1;padding:0 24px;}
.log-entry{padding:8px 0;border-bottom:1px dashed var(--border);font-size:13px;}
.log-entry.user{color:#4e9af1;}
.log-entry.agent{color:#22c55e;}

/* æŒ‰é’® */
#saveTrajectory{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--accent);color:#fff;border:none;border-radius:8px;
  padding:6px 12px;cursor:pointer;transition:background .2s;
}
#saveTrajectory:hover{background:#1d4fd7;}

/* èŠå¤©æ¡† */
#chat{
  position:fixed;
  top:80px;
  right:var(--safe-gutter);
  bottom:var(--safe-gutter);
  width:var(--chat-width);
  display:flex;flex-direction:column;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
}
#chat-messages{flex:1;overflow-y:auto;padding:18px;}
.message{display:flex;align-items:flex-start;margin:12px 0;gap:10px;}
.message.user{flex-direction:row-reverse;}
.avatar{width:32px;height:32px;border-radius:50%;background:#ccc;flex-shrink:0;}
.avatar.agent{background:url('https://img.icons8.com/color/48/bot.png') center/cover;}
.avatar.user{background:url('https://img.icons8.com/color/48/user.png') center/cover;}
.bubble{max-width:75%;padding:10px 14px;border-radius:12px;line-height:1.4;}
.message.agent .bubble{background:var(--msg-agent);border-radius:12px 12px 12px 4px;}
.message.user .bubble{background:var(--msg-user);color:#fff;border-radius:12px 12px 4px 12px;}
#chat-input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:var(--panel);}
#chat-input input{flex:1;background:var(--input-bg);border:none;border-radius:10px;padding:10px 12px;color:var(--text);}
#chat-input button{background:var(--accent);border:none;color:#fff;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:600;}

/* æ»šåŠ¨æ¡ */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-thumb{background:#333;border-radius:4px;}
/* è¿æ¥æ§åˆ¶æ¡æ ·å¼ */
.control-bar{display:flex;justify-content:center;gap:12px;margin:12px 0;}
.control-bar .btn{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--panel);color:var(--text);cursor:pointer}
.control-bar .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.control-bar .btn:disabled{opacity:0.6;cursor:not-allowed}
</style><!-- å¼•å…¥ web-scrcpy å®¢æˆ·ç«¯èµ„æºï¼ˆä¸ connect ä¿æŒä¸€è‡´ï¼‰ -->
    <script src="/static/js/socket.io.js"></script>
    <script src="/static/js/input.js?v=3"></script>
    <script src="/static/js/exp-golomb.js"></script>
    <script src="/static/js/h264-sps-parser.js"></script>
    <script src="/static/js/video_parser.js"></script>
    <script src="/static/js/jmuxer.min.js"></script>
</head>

<body>
<header>
  <h1>ğŸ§  Cognitive OS Agent</h1>
  <div style="display:flex;align-items:center;gap:16px;">
    <!-- æ›¿æ¢ä¸‹æ‹‰æ¡†ä¸ºâ€œæ¨¡å‹åŠ è½½â€æŒ‰é’®ï¼ˆä¸ä¸»é¢˜åˆ‡æ¢ä¸€è‡´çš„æ— è¾¹æ¡†æ ·å¼ï¼‰ -->
    <button id="modelLoadBtn" class="btn" style="background:none;border:none;color:inherit;cursor:pointer;font-size:14px;">ğŸ§© æ¨¡å‹åŠ è½½</button>
    <button id="headerControl" class="btn" style="background:none;border:none;color:inherit;cursor:pointer;font-size:14px;" disabled>è®¾å¤‡ç¦»çº¿</button>
    <button id="themeToggle" onclick="toggleTheme()" style="background:none;border:none;color:inherit;cursor:pointer;font-size:14px;">ğŸŒ“ Theme</button>
  </div>
</header>

<div class="stage">
  <div class="main-console">
    <!-- å·¦ï¼šæ‰‹æœº -->
    <div class="phone-container">
      <div class="phone-frame" id="phoneFrame">
        <video id="player" class="phone-screen" autoplay muted webkit-playsinline playsinline x5-playsinline></video>
        <!-- MJPEG å›é€€æ˜¾ç¤ºå®¹å™¨ï¼Œä¸ connect ä¿æŒä¸€è‡´ -->
        <img id="mjpeg" class="phone-screen" style="display:none" />
        <div class="phone-overlay" id="connectOverlay">
           <button id="btnConnect" class="btn">è¿æ¥å¹¶é¢„è§ˆ</button>
         </div>
        <div class="floating-panel" id="floatingPanel" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <h4>æ§åˆ¶ä¸­å¿ƒ</h4>
            <button id="btnClosePanel" class="btn" aria-label="å…³é—­æ§åˆ¶ä¸­å¿ƒ" style="padding:4px 8px">âœ•</button>
          </div>
          <div id="devicesSection" style="margin-bottom:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <b style="color:var(--accent);">è®¾å¤‡åˆ—è¡¨</b>
              <div style="display:flex;gap:8px;align-items:center;">
                <button id="btnRefreshDevices" class="btn">åˆ·æ–°è®¾å¤‡</button>
              </div>
            </div>
            <div id="deviceList" style="max-height:180px;overflow:auto;border:1px dashed var(--border);border-radius:8px;padding:8px"></div>
          </div>
          <div id="deviceInfoSection" style="margin:10px 0 12px 0;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <b style="color:var(--accent);">è®¾å¤‡ä¿¡æ¯</b>
              <div style="display:flex;gap:8px;align-items:center;"><button id="btnRefreshInfo" class="btn">åˆ·æ–°ä¿¡æ¯</button></div>
            </div>
            <div id="deviceInfoKV" class="details" style="margin:6px 0 8px 0;padding:10px;border:1px solid rgba(255,255,255,0.14);border-radius:10px;background:rgba(255,255,255,0.04)"></div>
           </div>
           <!-- å›æ»šï¼šç§»é™¤æ§åˆ¶ä¸­å¿ƒå¤æ‚å¡ç‰‡ï¼Œä¿ç•™å•è¡Œå¯¼èˆªæŒ‰é’® -->
           <div class="row" style="margin-top:10px;">
           <button id="btnBack" class="btn">è¿”å›</button>
           <button id="btnHome" class="btn">ä¸»é¡µ</button>
           <button id="btnMenu" class="btn">èœå•</button>
           <button id="btnVolDown" class="btn">éŸ³é‡-</button>
           <button id="btnVolUp" class="btn">éŸ³é‡+</button>
           <button id="btnScreenshot" class="btn primary">æˆªå›¾</button>
           </div>
           </div>
           <!-- å·²æŒ‰è¦æ±‚åˆ é™¤é€€å‡ºæŒ‰é’®ï¼ˆåŸä¸ºçº¢è‰²æ•´è¡Œï¼‰ -->
         </div>
       </div>

    <!-- å³ï¼šè½¨è¿¹ -->
    <div class="traj-panel">
      <div class="traj-header">
        <b>ğŸ§­ Trajectory</b>
        <button id="saveTrajectory">Save</button>
      </div>
      <div class="traj-grid">
        <div>
          <div class="traj-item">ï¼‹ New Frame</div>
          <div class="traj-desc">Updating Soon...</div>
        </div>
      </div>
    </div>

    <!-- ä¸‹ï¼šæ—¥å¿— -->
    <div class="logs-container">
      <h3>Execution Logs</h3>
      <div id="logArea"></div>
    </div>
  </div>
</div>

<!-- èŠå¤©ç•Œé¢ -->
<div id="chat">
  <div id="chat-messages">
    <div class="message agent">
      <div class="avatar agent"></div>
      <div class="bubble">Hello, I'm your mobile agent. What task should I execute?</div>
    </div>
  </div>
  <div id="chat-input">
    <input id="userInput" placeholder="Type your commandâ€¦ (e.g. æ‰“å¼€å¾®ä¿¡å¹¶ç»™å¼ ä¸‰å‘æ¶ˆæ¯)">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script>
function addLog(msg, role='system'){
  const log=document.createElement('div');
  log.className='log-entry '+(role==='user'?'user':'agent');
  log.textContent=(role==='user'?'ğŸ§‘â€ğŸ’» User: ':'ğŸ¤– Agent: ')+msg;
  document.getElementById('logArea').appendChild(log);
  log.scrollIntoView();
}
// è°ƒè¯•æ—¥å¿—æ§åˆ¶ï¼ˆå›é€€æ—¶ç¼ºå¤±ï¼Œè¡¥å›ï¼‰
window.LOG_VERBOSE = false;
const LOG_SAMPLE_N = 60;
function addDebug(msg){ if (window.LOG_VERBOSE) addLog(msg,'agent'); }
function addDebugSample(counter, prefix, len){ if (window.LOG_VERBOSE && counter % LOG_SAMPLE_N === 0) addLog(`${prefix} #${counter} é•¿åº¦=${len||0}`,'agent'); }

function sendMsg(){
  const ip=document.getElementById('userInput');
  const text=ip.value.trim(); if(!text) return;
  pushMsg('user', text);
  addLog(text,'user');
  ip.value='';
  setTimeout(()=>{
    const reply='Understood. Executing: '+text;
    pushMsg('agent', reply);
    addLog(reply,'agent');
  },500);
}

function pushMsg(role,text){
  const msg=document.createElement('div'); msg.className='message '+role;
  const avatar=document.createElement('div'); avatar.className='avatar '+role;
  const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=text;
  msg.appendChild(avatar); msg.appendChild(bubble);
  document.getElementById('chat-messages').appendChild(msg);
  msg.scrollIntoView();
}

/* ä¸»é¢˜åˆ‡æ¢ */
function toggleTheme(){
  const root=document.documentElement;
  const dark=getComputedStyle(root).getPropertyValue('--bg')==='#0f1117';
  if(dark){
    root.style.setProperty('--bg','#f5f6fa');
    root.style.setProperty('--panel','#ffffff');
    root.style.setProperty('--text','#1a1a1a');
    root.style.setProperty('--accent','#3b82f6');
    root.style.setProperty('--border','#e2e2e2');
    root.style.setProperty('--msg-user','#3b82f6');
    root.style.setProperty('--msg-agent','#e8e8ed');
    root.style.setProperty('--input-bg','#f0f1f5');
  } else {
    root.style.setProperty('--bg','#0f1117');
    root.style.setProperty('--panel','#1a1b26');
    root.style.setProperty('--text','#e5e5e5');
    root.style.setProperty('--accent','#4e9af1');
    root.style.setProperty('--border','#2a2a38');
    root.style.setProperty('--msg-user','#4e9af1');
    root.style.setProperty('--msg-agent','#2b2b3a');
    root.style.setProperty('--input-bg','#2a2a38');
  }
}



let socket = null;
let jmuxer = null;
let input = null;
// æ–°å¢ï¼šç»Ÿè®¡å¸§ä¸å›é€€å®šæ—¶å™¨
let feedCount = 0;
let fallbackTimer = null;

// æ–°å¢ï¼šæ ¹æ®è®¾å¤‡å®½é«˜æ¯”åŠ¨æ€è°ƒæ•´æ’­æ”¾å™¨å®½åº¦ï¼Œå‡å°‘å·¦å³é»‘è¾¹
function adjustPhoneScreen(w, h){
  try{
    if(!w || !h) return;
    const player = document.getElementById('player');
    if(!player) return;
    const heightPx = parseFloat(getComputedStyle(player).height) || 520;
    const widthPx = Math.max(1, Math.round(heightPx * (w / h)));
    player.style.width = widthPx + 'px';
  }catch(e){ /* å¿½ç•¥å¸ƒå±€è°ƒæ•´é”™è¯¯ */ }
}
function appendExecLog(msg){ addLog(msg,'agent'); }

function updateFloatingInfo(){
  const infoEl = document.getElementById('floatingInfo');
  if(!infoEl) return;
  infoEl.textContent = 'è®¾å¤‡ä¿¡æ¯åŠ è½½ä¸­...';
  Promise.all([
    fetch('/api/model').then(r=>r.json()).catch(()=>({model:'-'})),
    fetch('/api/resolution').then(r=>r.json()).catch(()=>({ok:false}))
  ]).then(([m, r])=>{
    const model = m?.model || '-';
    const resText = r?.ok ? `${r.width}x${r.height}` : '-';
    infoEl.textContent = `å‹å·ï¼š${model}ï¼Œåˆ†è¾¨ç‡ï¼š${resText}`;
  }).catch(()=>{ infoEl.textContent = 'è®¾å¤‡ä¿¡æ¯ä¸å¯ç”¨'; });
}

function toggleFloatingPanel(show){
  const panel = document.getElementById('floatingPanel');
  if (!panel) return;
  panel.style.display = show ? 'block' : 'none';
}

function renderDeviceList(devices){
  const box = document.getElementById('deviceList');
  if(!box){return;}
  if(!devices || devices.length===0){ box.innerHTML = '<div style="opacity:0.7">æœªå‘ç°è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ USB æˆ–ADBã€‚</div>'; return; }
  const html = devices.map((d,idx)=>{
    const info = `${d.serial}ï½œ${d.model||'-'}ï½œ${d.resolution||'-'}ï½œ${d.state||'-'}`;
    const serialAttr = (d.serial||'').replace(/"/g,'');
    return `<div>
      <label style="display:flex;align-items:center;gap:8px;padding:6px 4px;border-bottom:1px dashed var(--border)">
        <input type="radio" name="selDevice" value="${serialAttr}" ${idx===0?'checked':''} />
        <span>${info}</span>
      </label>
    </div>`;
  }).join('');
  box.innerHTML = html;
}
// æ–°å¢ï¼šè®¾å¤‡åˆ—è¡¨äº‹ä»¶å§”æ‰˜ï¼Œä¿®å¤æœªå®šä¹‰çš„ delegateDeviceList
function delegateDeviceList(){
  const box = document.getElementById('deviceList');
  if(!box) return;
  if(box.__delegated) return; // é˜²æ­¢é‡å¤ç»‘å®š
  box.__delegated = true;
  // ç›‘å¬è®¾å¤‡å•é€‰åˆ‡æ¢ï¼Œè‡ªåŠ¨åˆ·æ–°è®¾å¤‡ä¿¡æ¯
  box.addEventListener('change', (e) => {
    if(e.target && e.target.name === 'selDevice'){ refreshSelectedDeviceInfo(); }
  });
  // ç§»é™¤è®¾å¤‡é¡¹è¯¦æƒ…äº¤äº’ï¼Œè®¾å¤‡ä¿¡æ¯ç»Ÿä¸€åœ¨ä¸Šæ–¹åŒºå—æ˜¾ç¤º

}
async function fetchDevices(){
  try{
    const res = await fetch('/api/devices');
    const data = await res.json();
    if(data && data.ok){ renderDeviceList(data.devices||[]); refreshSelectedDeviceInfo(); }
    else{ renderDeviceList([]); refreshSelectedDeviceInfo(); }
  }catch(e){ console.error(e); renderDeviceList([]); refreshSelectedDeviceInfo(); }
}
function getSelectedSerial(){
  const sel = document.querySelector('input[name="selDevice"]:checked');
  return sel ? sel.value : null;
}
async function refreshSelectedDeviceInfo(){
  const serial = getSelectedSerial();
  const box = document.getElementById('deviceInfoKV');
  if(!box) return;
  if(!serial){ box.innerHTML = '<div style="opacity:0.7">æœªé€‰æ‹©è®¾å¤‡</div>'; return; }
  box.innerHTML = '<div style="opacity:0.7">è¯»å–è®¾å¤‡ä¿¡æ¯ä¸­â€¦</div>';
  try{
    const res = await fetch('/api/device_info?serial=' + encodeURIComponent(serial));
    const data = await res.json();
    if(data && data.ok){ box.innerHTML = buildDeviceOverview(data); }
    else{ box.innerHTML = '<div style="opacity:0.7">è®¾å¤‡ä¿¡æ¯ä¸å¯ç”¨</div>'; }
  }catch(err){ box.innerHTML = '<div style="color:#e57373">è¯»å–å¤±è´¥ï¼š' + (err?.message||err) + '</div>'; }
}
async function takeScreenshot(){
  try{
    const serial = getSelectedSerial();
    const url = serial ? `/api/screenshot?serial=${encodeURIComponent(serial)}` : '/api/screenshot';
    const res = await fetch(url);
    if(!res.ok){ throw new Error('æˆªå›¾æ¥å£è¿”å›é”™è¯¯'); }
    const blob = await res.blob();
    const imgUrl = URL.createObjectURL(blob);
    window.open(imgUrl, '_blank');
  }catch(e){ console.error(e); addLog('æˆªå›¾å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
}

function initInput(width, height) {
  const videoElement = document.getElementById('player');
  function input_data_cb(data) { socket.emit('control_data', data); }
  if (typeof ScrcpyInput !== 'undefined') {
    input = new ScrcpyInput(input_data_cb, videoElement, width, height, false);

    const backBtn = document.getElementById('btnBack');
    const homeBtn = document.getElementById('btnHome');
    const menuBtn = document.getElementById('btnMenu');
    const volDownBtn = document.getElementById('btnVolDown');
    const volUpBtn = document.getElementById('btnVolUp');

    backBtn && backBtn.addEventListener('mousedown', (e)=>{ input.snedKeyCode(e, 0, 4); });
    backBtn && backBtn.addEventListener('mouseup',   (e)=>{ input.snedKeyCode(e, 1, 4); });
    homeBtn && homeBtn.addEventListener('mousedown', (e)=>{ input.snedKeyCode(e, 0, 3); });
    homeBtn && homeBtn.addEventListener('mouseup',   (e)=>{ input.snedKeyCode(e, 1, 3); });
    menuBtn && menuBtn.addEventListener('mousedown', (e)=>{ input.snedKeyCode(e, 0, 187); });
    menuBtn && menuBtn.addEventListener('mouseup',   (e)=>{ input.snedKeyCode(e, 1, 187); });
    volDownBtn && volDownBtn.addEventListener('mousedown', (e)=>{ input.snedKeyCode(e, 0, 25); });
    volDownBtn && volDownBtn.addEventListener('mouseup',   (e)=>{ input.snedKeyCode(e, 1, 25); });
    volUpBtn && volUpBtn.addEventListener('mousedown', (e)=>{ input.snedKeyCode(e, 0, 24); });
    volUpBtn && volUpBtn.addEventListener('mouseup',   (e)=>{ input.snedKeyCode(e, 1, 24); });
  } else {
    // æ²¡æœ‰ ScrcpyInput åº“æ—¶ï¼Œä½¿ç”¨åç«¯ ADB å›é€€
    const backBtn = document.getElementById('btnBack');
    const homeBtn = document.getElementById('btnHome');
    const menuBtn = document.getElementById('btnMenu');
    const volDownBtn = document.getElementById('btnVolDown');
    const volUpBtn = document.getElementById('btnVolUp');
    backBtn && (backBtn.onclick = ()=>sendKeyEvent(4));
    homeBtn && (homeBtn.onclick = ()=>sendKeyEvent(3));
    menuBtn && (menuBtn.onclick = ()=>sendKeyEvent(82));
    volDownBtn && (volDownBtn.onclick = ()=>sendKeyEvent(25));
    volUpBtn && (volUpBtn.onclick = ()=>sendKeyEvent(24));
  }
}

// å…¼å®¹ï¼šè‹¥æœªèƒ½åŠ è½½ web-scrcpy çš„è§£æå™¨ä¸è¾“å…¥åº“ï¼Œåˆ™æä¾›ç®€åŒ–å®ç°
if (typeof VideoParser === 'undefined') {
  class SimpleVideoParser {
    constructor(cb){ this.cb = cb; this.buffer = new Uint8Array(0); this.sps=null; this.pps=null; }
    appendData(chunk){
      // è¿æ¥ç¼“å†²
      const merged = new Uint8Array(this.buffer.length + chunk.length);
      merged.set(this.buffer,0); merged.set(chunk,this.buffer.length);
      this.buffer = merged;
      // æŸ¥æ‰¾èµ·å§‹ç  00 00 01 æˆ– 00 00 00 01
      const starts = [];
      for(let i=0;i<this.buffer.length-4;i++){
        if(this.buffer[i]===0 && this.buffer[i+1]===0){
          if(this.buffer[i+2]===1){ starts.push(i+3); i+=2; }
          else if(this.buffer[i+2]===0 && this.buffer[i+3]===1){ starts.push(i+4); i+=3; }
        }
      }
      if(starts.length===0) return; // ç­‰å¾…æ›´å¤šæ•°æ®
      // æ„é€ ç‰‡æ®µ
      const segments=[];
      for(let i=0;i<starts.length;i++){
        const start=starts[i];
        const end=i+1<starts.length?starts[i+1]:this.buffer.length;
        const seg=this.buffer.slice(start,end);
        if(seg.length>0) segments.push(seg);
      }
      // ä¿ç•™æœ€åæœªå®Œæ•´çš„å°¾éƒ¨æ•°æ®
      const lastStart=starts[starts.length-1];
      this.buffer = this.buffer.slice(lastStart);
      // å‘é€ NALU
      for(const seg of segments){
        const nalType = seg[0] & 0x1f;
        if(nalType===7){ this.sps = seg; }
        else if(nalType===8){ this.pps = seg; }
        // é¦–æ¬¡æä¾› SPS/PPS
        if(this.sps && this.pps && !this._inited){
          this._inited = true;
          this.cb({ type:'init', data:{ sps:this.sps, pps:this.pps } });
        }
        this.cb({ type:'nalu', data: seg });
      }
    }
  }
  window.VideoParser = SimpleVideoParser;
}

// åç«¯ ADB æŒ‰é”®å›é€€ï¼ˆæ—  ScrcpyInput æ—¶ä½¿ç”¨ï¼‰
async function sendKeyEvent(code){
  try{
    const res = await fetch('/api/shell',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ cmd: `input keyevent ${code}` })
    });
    const data = await res.json();
    if(!data.ok) throw new Error('åç«¯æ‰§è¡Œå¤±è´¥');
    addLog(`å·²å‘é€æŒ‰é”® ${code}`,'agent');
  }catch(e){
    addLog(`æŒ‰é”®å¤±è´¥ ${code}: ${e?.message||e}`,'agent');
  }
}

let parser = null;

// æ–°å¢ï¼šMJPEG å›é€€é€»è¾‘ï¼ˆä¸ connect ä¸€è‡´ï¼‰
function startMjpegFallback(){
  const videoElement = document.getElementById('player');
  const mjpegEl = document.getElementById('mjpeg');
  addLog('æœªæ”¶åˆ°è§†é¢‘å¸§ï¼Œå¯ç”¨ MJPEG å›é€€æ˜¾ç¤ºâ€¦','agent');
  if (videoElement) videoElement.style.display = 'none';
  if (mjpegEl){ mjpegEl.style.display = 'block'; mjpegEl.src = '/stream'; }
}

function startPreview(){
  const videoElement = document.getElementById('player');
  const mjpegEl = document.getElementById('mjpeg');
  const overlay = document.getElementById('connectOverlay');
  if (!videoElement) return;

  // æ¸…ç†æ—§è¿æ¥ä¸å®šæ—¶å™¨
  try{ socket && socket.disconnect(); }catch{}
  feedCount = 0;
  if (fallbackTimer){ clearTimeout(fallbackTimer); fallbackTimer = null; }
  if (mjpegEl){ mjpegEl.style.display = 'none'; if (mjpegEl.src) mjpegEl.src = ''; }
  videoElement.style.display = 'block';
  let jmuxerReady = false;
  let initFed = false;
  let pendingInit = null;
  let pendingFrames = [];
  const MAX_PENDING = 120; // é™åˆ¶ç¼“å­˜å¸§æ•°é‡ï¼Œé¿å…çªå‘
  let draining = false;
  let parserFrameCount = 0;
  let jmuxerFeedCount = 0;
  const drainPending = () => {
    if (!jmuxerReady || !initFed) return;
    if (draining) return;
    draining = true;
    const pump = () => {
      try{
        if (!jmuxerReady || !initFed) { draining = false; return; }
        const f = pendingFrames.shift();
        if (f) {
          jmuxer && jmuxer.feed({ video: f });
          jmuxerFeedCount += 1;
          addLog('JMuxer æ’é˜Ÿé€å¸§ #' + jmuxerFeedCount + ' é•¿åº¦=' + (f?.length||0),'agent');
          setTimeout(pump, 10);
        } else {
          draining = false;
        }
      }catch(e){
        draining = false;
        addLog('æ’é˜Ÿé€å¸§å¤±è´¥ï¼š' + ((e && (e.message || e.msg || e.name)) || String(e)), 'agent');
      }
    };
    pump();
  };

  if (typeof VideoParser === 'undefined') { addLog('VideoParser æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ /ws-assets/js/ å¼•å…¥','agent'); return; }
  parser = new VideoParser(({ type, data }) => {
    try {
      if (type === 'init' && data) {
        pendingInit = data;
        if (jmuxerReady) {
          jmuxer && jmuxer.feed({ video: data["sps"] });
          jmuxer && jmuxer.feed({ video: data["pps"] });
          initFed = true;
          addLog('æ”¶åˆ° SPS/PPSï¼Œåˆå§‹åŒ–å®Œæˆ','agent');
          drainPending();
        }
      } else if (type === 'nalu' || type === 'frame') {
        parserFrameCount += 1;
        // addLog('è§£æå™¨è¾“å‡ºå¸§ #' + parserFrameCount + ' é•¿åº¦=' + (data?.length||0),'agent');
        if (!jmuxerReady || !initFed) {
          if (pendingFrames.length < MAX_PENDING) pendingFrames.push(data);
        } else {
          jmuxer && jmuxer.feed({ video: data });
          jmuxerFeedCount += 1;
          // addLog('JMuxer å·²é€å¸§ #' + jmuxerFeedCount + ' é•¿åº¦=' + (data?.length||0),'agent');
        }
      } else if (type === 'screen_size') {
        initInput(data["width"], data["height"]);
        adjustPhoneScreen(data["width"], data["height"]);
      } else if (type === 'size_change') {
        if (input) { input.resizeScreen(data["width"], data["height"]); }
        adjustPhoneScreen(data["width"], data["height"]);
      }
    } catch (feedErr) {
      addLog('JMuxer feed é”™è¯¯: ' + ((feedErr && (feedErr.message || feedErr.msg || feedErr.name)) || String(feedErr)),'agent');
    }
  });

  if (typeof JMuxer === 'undefined') { addLog('JMuxer æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥è„šæœ¬å¼•å…¥','agent'); return; }
  jmuxer = new JMuxer({
    node: 'player',
    mode: 'video',
    // ä½å»¶è¿Ÿé…ç½®ï¼šä¸ connect.html ä¿æŒä¸€è‡´
    flushingTime: 0,
    fps: 60,
    clearBuffer: true,
    onReady: () => {
      jmuxerReady = true;
      addLog('MSE å°±ç»ªï¼Œç­‰å¾…è§†é¢‘æ•°æ®â€¦','agent');
      try {
        if (pendingInit && !initFed) {
          jmuxer && jmuxer.feed({ video: pendingInit["sps"] });
          jmuxer && jmuxer.feed({ video: pendingInit["pps"] });
          initFed = true;
          addLog('å·²åœ¨ MSE å°±ç»ªåé€å‡º SPS/PPS','agent');
        }
        drainPending();
      } catch (e) {
        addLog('å°±ç»ªåé€å‡ºç¼“å­˜å¸§å¤±è´¥ï¼š' + ((e && (e.message || e.msg || e.name)) || String(e)),'agent');
      }
      videoElement.controls = false;
      videoElement.muted = true;
      videoElement.autoplay = true;
      videoElement.playsInline = true;
      try { videoElement.play(); } catch(e) { addLog('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢: ' + (e?.message||e),'agent'); }
      fallbackTimer = setTimeout(() => { if (feedCount === 0 && (typeof statsPackets === 'number' ? statsPackets : 0) === 0) startMjpegFallback(); }, 5000);
    },
    onError: (err) => {
      addLog('MSE é”™è¯¯ï¼š' + ((err && (err.message || err.msg || err.name)) || String(err)),'agent');
      // å‡ºé”™åæš‚ç¼“é€å…¥ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ onReady
      jmuxerReady = false;
      initFed = false;
    }
  });
  socket = io({ reconnection: false, autoConnect: true });

  // è§‚å¯Ÿæ‰€æœ‰äº‹ä»¶ï¼ˆä»…åœ¨è¯¦ç»†æ¨¡å¼ï¼‰
  if (window.LOG_VERBOSE && socket && typeof socket.onAny === 'function') {
    socket.onAny((event, ...args) => {
      try{ addDebug('Socket äº‹ä»¶ï¼š' + event + ' (' + (args?.length||0) + ' ä¸ªå‚æ•°)'); }catch{}
    });
  }

  socket.on('connect_error', (err) => { addLog('Socket è¿æ¥é”™è¯¯ï¼š' + ((err && (err.message||err))||'unknown'),'agent'); });
  socket.on('reconnect_attempt', () => { addDebug('Socket æ­£åœ¨å°è¯•é‡è¿â€¦'); });
  socket.on('reconnect_error', (err) => { addLog('Socket é‡è¿é”™è¯¯ï¼š' + ((err && (err.message||err))||'unknown'),'agent'); });
  socket.on('reconnect_failed', () => { addLog('Socket é‡è¿å¤±è´¥','agent'); });

  socket.on('video_data', async (data) => {
    try{
      let bytes = null;
      if (data instanceof ArrayBuffer) {
        bytes = new Uint8Array(data);
      } else if (typeof Blob !== 'undefined' && data instanceof Blob) {
        const buf = await data.arrayBuffer();
        bytes = new Uint8Array(buf);
      } else if (typeof ArrayBuffer !== 'undefined' && ArrayBuffer.isView && ArrayBuffer.isView(data)) {
        bytes = new Uint8Array(data.buffer, data.byteOffset || 0, data.byteLength || data.length || 0);
      } else if (data && data.buffer instanceof ArrayBuffer && typeof data.byteLength === 'number') {
        const offset = data.byteOffset || 0;
        const len = data.byteLength;
        bytes = new Uint8Array(data.buffer, offset, len);
      } else if (typeof data === 'string') {
        try {
          const bin = atob(data);
          const arr = new Uint8Array(bin.length);
          for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
          bytes = arr;
        } catch(e) {}
      }
      if (!bytes) { addDebug('æ”¶åˆ°æœªçŸ¥ç±»å‹è§†é¢‘å—ï¼š' + Object.prototype.toString.call(data)); return; }
      feedCount += 1;
      addDebugSample(feedCount, 'æ”¶åˆ°è§†é¢‘å—', bytes.length);
      parser && parser.appendData(bytes);
    }catch(err){ addLog('å¤„ç†è§†é¢‘å—å¤±è´¥ï¼š' + (err?.message||err),'agent'); }
  });
  
  // æœåŠ¡å™¨å‘é€ç»Ÿè®¡ï¼šä»…åœ¨è¯¦ç»†æ¨¡å¼æ˜¾ç¤º
  socket.on('video_stats', (s) => { statsPackets = s?.packets||0; addDebug(`æœåŠ¡å™¨å‘é€ç»Ÿè®¡ packets=${s?.packets||0} bytes=${s?.bytes||0}`); });

  socket.on('connect', () => {
    addLog('Socket å·²è¿æ¥ï¼Œå¼€å§‹æ¥æ”¶è§†é¢‘â€¦','agent');
    if (overlay) overlay.style.display = 'none';
    const panel = document.getElementById('floatingPanel'); if (panel) panel.style.display = 'none';
    const headerControl = document.getElementById('headerControl');
    if (headerControl) { headerControl.textContent = 'æ§åˆ¶é¢æ¿'; headerControl.disabled = false; }
  });

  socket.on('disconnect', () => {
    addLog('Socket å·²æ–­å¼€','agent');
    if (fallbackTimer){ clearTimeout(fallbackTimer); fallbackTimer = null; }
    if (overlay) overlay.style.display = 'flex';
    const panel = document.getElementById('floatingPanel'); if (panel) panel.style.display = 'none';
    const headerControl = document.getElementById('headerControl'); if (headerControl) { headerControl.textContent = 'è®¾å¤‡ç¦»çº¿'; headerControl.disabled = true; }
    if (mjpegEl){ mjpegEl.style.display = 'none'; if (mjpegEl.src) mjpegEl.src = ''; }
  });

  socket.on('error', (error) => { addLog('WebSocket é”™è¯¯ï¼š' + (error?.message || error),'agent'); });

  window.addEventListener('beforeunload', () => { socket && socket.disconnect(); });
}

function stopPreview(){
  try{
    socket && socket.disconnect();
  }catch{}
  try{
    if (jmuxer && typeof jmuxer.destroy === 'function') jmuxer.destroy();
  }catch{}
  jmuxer = null;
  const overlay = document.getElementById('connectOverlay');
  if (overlay) overlay.style.display = 'flex';
  toggleFloatingPanel(false);
  const headerControl = document.getElementById('headerControl');
  if (headerControl) { headerControl.textContent = 'è®¾å¤‡ç¦»çº¿'; headerControl.disabled = true; }
  addLog('åœæ­¢é¢„è§ˆ','agent');
}

function wireControls(){
  const byId = id => document.getElementById(id);
  const connectBtn = byId('btnConnect');
  const phoneFrame = byId('phoneFrame');
  const disconnectBtn = byId('btnDisconnect');

  if(connectBtn) connectBtn.onclick = startPreview;
  // å¤´éƒ¨â€œæ§åˆ¶é¢æ¿â€
  const headerControl = byId('headerControl');
  if(headerControl) headerControl.onclick = () => {
    if (socket && socket.connected) { fetchDevices(); delegateDeviceList(); toggleFloatingPanel(true); refreshSelectedDeviceInfo(); }
    else { addLog('è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•æ‰“å¼€æ§åˆ¶ä¸­å¿ƒ','agent'); }
  };
  // æ¨¡å‹åŠ è½½æŒ‰é’®ä¸é¢æ¿
  const modelLoadBtn = byId('modelLoadBtn');
  const modelSheet = byId('modelSheet');
  const modelSheetClose = byId('modelSheetClose');
  if(modelLoadBtn){ modelLoadBtn.onclick = () => { modelSheet.style.display = 'block'; }; }
  if(modelSheetClose){ modelSheetClose.onclick = () => { modelSheet.style.display = 'none'; }; }
  // é€‰æ‹©æ¨¡å‹ï¼šè®¾ç½®æ¿€æ´»æ€å¹¶è®°å½•å½“å‰æ¨¡å‹
  const cards = document.querySelectorAll('#modelSheet .model-card');
  cards.forEach(card => {
    card.addEventListener('click', () => {
      const id = card.getAttribute('data-id');
      window.currentModel = id;
      // é«˜äº®é€‰ä¸­é¡¹
      cards.forEach(c => { c.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border'); });
      card.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
      addLog('å·²é€‰æ‹©æ¨¡å‹ï¼š' + id, 'agent');
      modelSheet.style.display = 'none';
    });
  });

  // æ§åˆ¶ä¸­å¿ƒå…³é—­ä¸å…¶ä»–ç»‘å®š ...
  const btnClosePanel = byId('btnClosePanel');
  if(btnClosePanel) btnClosePanel.onclick = () => { toggleFloatingPanel(false); };
  const btnRefreshDevices = document.getElementById('btnRefreshDevices');
  btnRefreshDevices && (btnRefreshDevices.onclick = fetchDevices);
  const btnScreenshot = document.getElementById('btnScreenshot');
  btnScreenshot && (btnScreenshot.onclick = takeScreenshot);
  const btnRefreshInfo = byId('btnRefreshInfo');
  btnRefreshInfo && (btnRefreshInfo.onclick = refreshSelectedDeviceInfo);
  // å¿«æ·æ“ä½œäº‹ä»¶ç»‘å®š
  const serialGetter = () => getSelectedSerial();
  const btnCopyDevice = byId('btnCopyDevice');
  const btnPasteDevice = byId('btnPasteDevice');
  const btnClipboardPull = byId('btnClipboardPull');
  const btnClipboardPush = byId('btnClipboardPush');
  const btnClipboardPushPaste = byId('btnClipboardPushPaste');
  const btnClipboardSet = byId('btnClipboardSet');
  const clipboardInput = byId('clipboardInput');
  const typeEnterInput = byId('typeEnterInput');
  const btnTypeEnter = byId('btnTypeEnter');
  const openUrlInput = byId('openUrlInput');
  const btnOpenUrl = byId('btnOpenUrl');
  const ccSerialEl = byId('ccSerial');
  if(ccSerialEl){ ccSerialEl.textContent = getSelectedSerial() || '-'; }
 
  btnCopyDevice && (btnCopyDevice.onclick = () => sendKeyEvent(278)); // KEYCODE_COPY
  btnPasteDevice && (btnPasteDevice.onclick = () => sendKeyEvent(279)); // KEYCODE_PASTE

  btnClipboardPull && (btnClipboardPull.onclick = async () => {
    const serial = serialGetter();
    if(!serial){ addLog('æœªé€‰æ‹©è®¾å¤‡','agent'); return; }
    try{
      const res = await fetch('/api/clipboard?serial=' + encodeURIComponent(serial));
      const data = await res.json();
      if(data && data.ok){
        try{ await navigator.clipboard.writeText(data.text || ''); addLog('å·²åŒæ­¥è®¾å¤‡å‰ªè´´æ¿åˆ°æœ¬åœ°','agent'); }
        catch(e){ addLog('å†™å…¥æœ¬åœ°å‰ªè´´æ¿å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
      } else {
        addLog('è¯»å–è®¾å¤‡å‰ªè´´æ¿å¤±è´¥','agent');
      }
    }catch(e){ addLog('åŒæ­¥å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
  });

  btnClipboardPush && (btnClipboardPush.onclick = async () => {
    const serial = serialGetter();
    if(!serial){ addLog('æœªé€‰æ‹©è®¾å¤‡','agent'); return; }
    try{
      const text = await navigator.clipboard.readText();
      const res = await fetch('/api/clipboard', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ serial, text }) });
      const data = await res.json();
      if(data && data.ok){ addLog('å·²å°†æœ¬åœ°å‰ªè´´æ¿åŒæ­¥åˆ°è®¾å¤‡','agent'); }
      else { addLog('åŒæ­¥åˆ°è®¾å¤‡å¤±è´¥','agent'); }
    }catch(e){ addLog('åŒæ­¥å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
  });

  btnClipboardPushPaste && (btnClipboardPushPaste.onclick = async () => {
    const serial = serialGetter();
    if(!serial){ addLog('æœªé€‰æ‹©è®¾å¤‡','agent'); return; }
    try{
      const text = await navigator.clipboard.readText();
      const res = await fetch('/api/clipboard', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ serial, text }) });
      const data = await res.json();
      if(data && data.ok){ sendKeyEvent(279); addLog('å·²åŒæ­¥å¹¶è§¦å‘ç²˜è´´','agent'); }
      else { addLog('åŒæ­¥åˆ°è®¾å¤‡å¤±è´¥','agent'); }
    }catch(e){ addLog('åŒæ­¥å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
  });

  btnClipboardSet && (btnClipboardSet.onclick = async () => {
    const serial = serialGetter();
    if(!serial){ addLog('æœªé€‰æ‹©è®¾å¤‡','agent'); return; }
    const text = (clipboardInput?.value || '').trim();
    try{
      const res = await fetch('/api/clipboard', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ serial, text }) });
      const data = await res.json();
      if(data && data.ok){ addLog('å·²è®¾ç½®è®¾å¤‡å‰ªè´´æ¿','agent'); }
      else { addLog('è®¾ç½®è®¾å¤‡å‰ªè´´æ¿å¤±è´¥','agent'); }
    }catch(e){ addLog('è®¾ç½®å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
  });

  btnTypeEnter && (btnTypeEnter.onclick = async () => {
    const text = (typeEnterInput?.value || '').trim();
    if(!text){ addLog('è¯·è¾“å…¥è¦å‘é€çš„æ–‡æœ¬','agent'); return; }
    const safe = text.replace(/%/g,'%25').replace(/\s/g,'%s').replace(/\n/g,'\\n');
    try{
      await fetch('/api/shell', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cmd: `input text ${safe}` }) });
      await sendKeyEvent(66); // ENTER
      addLog('å·²è¾“å…¥æ–‡æœ¬å¹¶æŒ‰å›è½¦','agent');
    }catch(e){ addLog('è¾“å…¥å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
  });

  btnOpenUrl && (btnOpenUrl.onclick = async () => {
    const serial = serialGetter();
    if(!serial){ addLog('æœªé€‰æ‹©è®¾å¤‡','agent'); return; }
    const url = (openUrlInput?.value || '').trim();
    if(!url){ addLog('è¯·è¾“å…¥è¦æ‰“å¼€çš„é“¾æ¥','agent'); return; }
    try{
      const res = await fetch('/api/open_url', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ serial, url }) });
      const data = await res.json();
      if(data && data.ok){ addLog('å·²åœ¨è®¾å¤‡ä¸­æ‰“å¼€é“¾æ¥','agent'); }
      else { addLog('æ‰“å¼€é“¾æ¥å¤±è´¥','agent'); }
    }catch(e){ addLog('æ‰“å¼€å¤±è´¥ï¼š'+(e?.message||e),'agent'); }
  });
  if(disconnectBtn) disconnectBtn.onclick = stopPreview;
}

window.addEventListener('load', wireControls);

function buildDeviceKV(info){
  function fmtUptime(sec){
    if(sec==null) return '-';
    const s = Math.floor(sec);
    const d = Math.floor(s/86400);
    const h = Math.floor((s%86400)/3600);
    const m = Math.floor((s%3600)/60);
    return `${d>0?d+'å¤© ':''}${h}å°æ—¶ ${m}åˆ†`;
  }
  const tempC = (info?.battery?.temperature!=null) ? (info.battery.temperature/10).toFixed(1)+ 'Â°C' : '-';
  const memTotal = (info?.memory?.total_kb!=null) ? Math.round(info.memory.total_kb/1024)+' MB' : '-';
  const memAvail = (info?.memory?.available_kb!=null) ? Math.round(info.memory.available_kb/1024)+' MB' : '-';
  const entries = [
    ['åºåˆ—å·', info.serial_prop || info.serial],
    ['å‹å·', info.model],
    ['å“ç‰Œ', info.brand],
    ['åˆ¶é€ å•†', info.manufacturer],
    ['è®¾å¤‡å', info.device],
    ['äº§å“å', info.product],
    ['Androidç‰ˆæœ¬', info.android],
    ['SDK', info.sdk],
    ['æ„å»ºID', info.build_id],
    ['å¢é‡ç‰ˆæœ¬', info.incremental],
    ['å®‰å…¨è¡¥ä¸', info.security_patch],
    ['æŒ‡çº¹', info.fingerprint],
    ['CPU ABI', info.abi_list],
    ['ç¡¬ä»¶', info.hardware],
    ['å¹³å°', info.platform],
    ['åˆ†è¾¨ç‡', info.resolution],
    ['å¯†åº¦', info.density!=null ? info.density + ' dpi' : '-'],
    ['æ—‹è½¬', info.rotation!=null ? info.rotation : '-'],
    ['ç”µæ± ç”µé‡', info?.battery?.level!=null ? info.battery.level + '%' : '-'],
    ['ç”µæ± çŠ¶æ€', info?.battery?.status || '-'],
    ['ç”µæ± æ¸©åº¦', tempC],
    ['ç”µæ± å¥åº·', info?.battery?.health || '-'],
    ['IPåœ°å€', info.ip],
    ['MACåœ°å€', info.mac],
    ['å­˜å‚¨æ€»é‡', info?.storage?.size || '-'],
    ['å·²ç”¨', info?.storage?.used || '-'],
    ['å¯ç”¨', info?.storage?.avail || '-'],
    ['å†…å­˜æ€»é‡', memTotal],
    ['å¯ç”¨å†…å­˜', memAvail],
    ['è¿è¡Œæ—¶é•¿', fmtUptime(info?.uptime_seconds)],
  ];
  const rows = entries.map(([k,v])=>`<div class="kv-item-label">${k}</div><div class="kv-item-value">${(v??'-')}</div>`).join('');
  return `<div class="kv-list">${rows}</div>`;
}
function buildDeviceOverview(info){
  function codename(ver){
    const map={ '14':'UpsideDownCake','13':'Tiramisu','12':'Snow Cone','11':'R','10':'Q' };
    return map[String(ver)]||'';
  }
  function fmtUptime(sec){
    if(sec==null) return '-';
    const s = Math.floor(sec);
    const d = Math.floor(s/86400);
    const h = Math.floor((s%86400)/3600);
    const m = Math.floor((s%3600)/60);
    return `${d>0?d+'å¤© ':''}${h}å°æ—¶ ${m}åˆ†`;
  }
  const tempC = (info?.battery?.temperature!=null) ? (info.battery.temperature/10).toFixed(1)+ 'Â°C' : '-';
  const memTotal = (info?.memory?.total_kb!=null) ? Math.round(info.memory.total_kb/1024)+' MB' : '-';
  const memAvail = (info?.memory?.available_kb!=null) ? Math.round(info.memory.available_kb/1024)+' MB' : '-';
  const batteryPct = info?.battery?.level!=null ? `${info.battery.level}%` : '-';
  const batteryStatus = info?.battery?.status ? `ï¼ˆ${info.battery.status}ï¼‰` : '';
  const androidCodename = codename(info?.android);
  const items = [
    {label:'åˆ¶é€ å•†', icon:'â“˜', value: info.manufacturer || '-'},
    {label:'å‹å·', icon:'â“˜', value: info.model || '-'},
    {label:'å“ç‰Œ', icon:'ğŸ·ï¸', value: info.brand || '-'},
    {label:'è®¾å¤‡å', icon:'ğŸ“±', value: info.device || '-'},
    {label:'äº§å“å', icon:'ğŸ§©', value: info.product || '-'},
    {label:'Androidç‰ˆæœ¬', icon:'ğŸ¤–', value: `${info.android || '-'}${androidCodename? ' ('+androidCodename+')':''}`},
    {label:'SDK', icon:'âš™ï¸', value: info.sdk || '-'},
    {label:'æ„å»ºID', icon:'ğŸ”§', value: info.build_id || '-'},
    {label:'å¢é‡ç‰ˆæœ¬', icon:'ğŸ”§', value: info.incremental || '-'},
    {label:'å®‰å…¨è¡¥ä¸', icon:'ğŸ›¡ï¸', value: info.security_patch || '-'},
    {label:'æŒ‡çº¹', icon:'ğŸ”', value: info.fingerprint || '-'},
    {label:'CPU ABI', icon:'ğŸ–¥ï¸', value: info.abi_list || '-'},
    {label:'ç¡¬ä»¶', icon:'ğŸ”©', value: info.hardware || '-'},
    {label:'å¹³å°', icon:'ğŸ§±', value: info.platform || '-'},
    {label:'åºåˆ—å·', icon:'#', value: info.serial_prop || info.serial || '-'},
    {label:'åˆ†è¾¨ç‡', icon:'ğŸ–¼ï¸', value: info.resolution || '-'},
    {label:'å¯†åº¦', icon:'ğŸ–¨ï¸', value: (info.density!=null ? info.density + ' dpi' : '-')},
    {label:'æ—‹è½¬', icon:'â†»', value: (info.rotation!=null ? info.rotation : '-')},
    {label:'IPåœ°å€', icon:'ğŸŒ', value: info.ip || '-'},
    {label:'MACåœ°å€', icon:'ğŸªª', value: info.mac || '-'},
    {label:'ç”µæ± ç”µé‡', icon:'ğŸ”‹', value: `${batteryPct} ${batteryStatus}`.trim()},
    {label:'ç”µæ± æ¸©åº¦', icon:'ğŸŒ¡ï¸', value: tempC},
    {label:'ç”µæ± å¥åº·', icon:'â¤ï¸', value: (info?.battery?.health || '-')},
    {label:'å­˜å‚¨æ€»é‡', icon:'ğŸ’¾', value: info?.storage?.size || '-'},
    {label:'å·²ç”¨', icon:'ğŸ’¾', value: info?.storage?.used || '-'},
    {label:'å¯ç”¨', icon:'ğŸ’¾', value: info?.storage?.avail || '-'},
    {label:'å†…å­˜æ€»é‡', icon:'ğŸ§ ', value: memTotal},
    {label:'å¯ç”¨å†…å­˜', icon:'ğŸ§ ', value: memAvail},
    {label:'è¿è¡Œæ—¶é•¿', icon:'â±ï¸', value: fmtUptime(info?.uptime_seconds)},
  ];
  const rows = items.map(it=>`<div class=\"ov-item\"><div class=\"ov-label\">${it.icon} ${it.label}</div><div class=\"ov-value\">${it.value ?? '-'}</div></div>`).join('');
  // è¿”å›å•ä¸€å®¹å™¨ä¸­çš„åŒåˆ—ç½‘æ ¼ï¼Œä¸å†åŒ…å«â€œæ¦‚è§ˆâ€æ ‡é¢˜æˆ–å†…å±‚å¡ç‰‡
  return `<div class=\"ov-grid\">${rows}</div>`;
}

</script>
<!-- æ¨¡å‹é€‰æ‹©é¢æ¿ï¼šè½»é‡å¼¹çª—ï¼ˆæ”¾ç½®äº body ç»“æŸå‰ï¼‰ -->
<div id="modelSheet" style="position:fixed;right:24px;top:64px;z-index:1200;display:none;
  background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.45);
  width:360px;overflow:hidden;">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);">
    <b style="color:var(--accent)">é€‰æ‹©æ¨¡å‹</b>
    <button id="modelSheetClose" class="btn" style="padding:4px 8px;">âœ•</button>
  </div>
  <div style="display:grid;grid-template-columns:1fr;gap:10px;padding:12px;">
    <div class="model-card" data-id="ui-tars" style="display:flex;gap:12px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;cursor:pointer;">
      <img src="/static/imgs/ui-tars.png" alt="UI-TARS" style="width:48px;height:48px;border-radius:8px;object-fit:cover" />
      <div>
        <div style="font-weight:600;">UI-TARS</div>
        <div style="font-size:12px;color:#a9abb3">ä»¥è§†è§‰äº¤äº’ä¸ºä¸»çš„ UI Agent</div>
      </div>
    </div>
    <div class="model-card" data-id="agentcpm-gui" style="display:flex;gap:12px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;cursor:pointer;">
      <img src="/static/imgs/agentcpm-gui.png" alt="AgentCPM-GUI" style="width:48px;height:48px;border-radius:8px;object-fit:cover" />
      <div>
        <div style="font-weight:600;">AgentCPM-GUI</div>
        <div style="font-size:12px;color:#a9abb3">ä¸­æ–‡å¤šæ¨¡æ€ï¼Œè¡¨æ ¼æ§ä»¶æ”¯æŒ</div>
      </div>
    </div>
    <div class="model-card" data-id="gui-owl" style="display:flex;gap:12px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;cursor:pointer;">
      <img src="/static/imgs/gui-owl.jpeg" alt="GUI-Owl" style="width:48px;height:48px;border-radius:8px;object-fit:cover" />
      <div>
        <div style="font-weight:600;">GUI-Owl</div>
        <div style="font-size:12px;color:#a9abb3">è½»é‡ã€å¿«é€Ÿçš„ç•Œé¢ç†è§£</div>
      </div>
    </div>
  </div>
</div>
</body>
</html>